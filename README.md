# onecover-nodeproxy

## Замер покрытия кода тестами 1С:Предприятия

### Состав библиотеки

- proxy - логирующий реверс-прокси для 1С
- cover - конвертор логов proxy в формат [genericCoverage](https://docs.sonarqube.org/latest/analysis/generic-test/) и lcov

### Требования к окружению

- ОС Windows
- Платформа 1С версии не ниже 8.3
- node.js
- репозиторий с конфигурацией, выгруженной в формате XML или EDT
- проект в SonarQube, связанный с целевой конфигурацией

Библиотека сама поднимает экземпляр сервера отладки 1С во время работы, поэтому иметь отдельную службу не обязательно

### Как собирать замеры

Все операции должны выполняться под одним и тем же пользователем ОС.

#### Вручную

- установить библиотеку `1coverage`
- зарегистрировать и подготовить ИБ, на которой будут выполняться замеры
- добавить в локальный репозиторий файл настроек, отредактировать параметры
- указать путь к файлу с замерами в `sonar-project.properties`
- выполнить `1coverage init`
- в открывшемся конфигураторе запустить клиент 1С с отладкой
- выполнить автоматические тесты или любые действия интерактивно

> Перед выполнением действий, описанных ниже, клиент 1С должен оставаться открытым!

- выполнить `1coverage stop`
- выполнить `1coverage convert`
- выполнить `sonar-scanner`

#### На сервере сборки

- установить библиотеку `1coverage`
- добавить в репозиторий файл настроек, отредактировать параметры в нем или передать их через переменные окружения
- добавить в параметры запуска клиентов тестирования ключи для подключения к серверу отладки (см. документацию по используемому продукту)
- указать путь к файлу с замерами в `sonar-project.properties`

- отредактировать скрипт сборки:
    -- после шагов по созданию тестовой ИБ добавить команду `1coverage init`
    -- после выполнения всех тестов добавить команды `1coverage stop` и `1coverage convert`

- запустить билд

- убедиться, что в SonarQube появилась информация о покрытии

### Known issues

1) Из-за особенностей работы платформы 1С замеры собираются только тогда, когда отладка остановлена явным образом: интерактивно в конфигураторе или с помощью специального запроса к серверу отладки. По этой же причине не собираются замеры в коде, который выполняется в фоновых заданиях, поэтому этот код надо запускать синхронно. В БСП для этого предусмотрен параметр `/РежимОтладки`
